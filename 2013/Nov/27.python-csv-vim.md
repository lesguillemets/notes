お好みの言語で csv をちょっとだけ処理する
------------------------------------------

Python から csv を読む話は以前にも[しました](https://github.com/lesguillemets/notes/blob/master/2013/Oct/31-python-readcsv.md)が，
普段使わないライブラリを `import` すると脳内のメモリを過剰に消費します．
いま自分で読み返して `csv` モジュールで非常に楽に読み書きできることに驚きましたが，
例えば深夜にだらだら手を付けないでいたら期日が翌日に迫っていたレポートを書くに当たって 
csv ファイル（という名のエクセルファイル）にちょっとした処理を付け加えてデータを得たい（ある列とある列の積でもうひとつデータ列をとりたい，とか），
というような場合には，手が停まってしまうおそれがあります．これではいけません．

また，シンプルで性質のよい csv なら別に一行ずつ読んで処理しても大したことはないとはいえ，
お使いの言語によっては python のように手軽に csv を読めるモジュールが用意されていないかも知れません．

そんな時に，使用する脳内メモリを最小限に抑えながら，お好みの言語で csv を処理するとっておきの方法があります．

そうです．**Vim です．**

csv は結局テキストファイルですし，Vim はテキストエディタですから，Vim でテキストをエディットすれば
お使いの言語のコードに変形するのも自由自在なはず．早速やってみましょう．

以下，csv を python のリストにしてみます．

csv は tab 区切りで，すごくシンプルなこんなやつを使ってみます．

```csv
apple	23	56
banana	123	56
pineapple	233	56
watermelon'23	56
```

ひとつのやり方は置換を繰り返す．文字列を `''` で囲い，
行頭に `[`, 行末に `],` を入れ， `Tab` を `, ` に置換すればこの場合はよい．
文字列判定もこの場合は簡単に単語を作る文字が並んで最後に Tab か行末，だから

```Vim
:%s/\(\h\+\)\(\t\|$\)/'\1'\2/g
```

でよい．`\(\h\+\w*\)\(\t\|$\)` とかにすればもうちょっと広く使えるんじゃないかな．
簡単ってこれ最近 syntax file で似たのを読んだからそう思うだけなんですが．

あとは

```vim
:%s/^/[/
:%s/$/],/
:%s/\t/, /g

```

で

```Python
['apple', 23, 56],
['banana', 123, 56],
['pineapple', 233, 56],
['watermelon', 23, 56],
```

になるから最後に全体を `[]` で囲ってやればよい．

あとは `set ft=python` して，スクリプト部分を書き足して，`Quickrun` して，
出力を `y`ank して今書いてる `.tex` に貼り付ければよいわけです．

別法としては， [tpope/vim-surround](https://github.com/tpope/vim-surround) を使って
`yss]` とマクロで戦う手があります．

一行目にカーソル置いて `qq` (ふた文字目は小文字ならなんでもいい)でマクロ記録開始，
`yss]` でこうなる

```csv
[apple	23	56]
banana	123	56
pineapple	233	56
watermelon	23	56
```

`<Esc>j` でカーソルを 1つしたにずらして `q` で記録終了，この場合 3 more lines to go なので `3@q` で

```python
[apple	23	56]
[banana	123	56]
[pineapple	233	56]
[watermelon	23	56]
```

マクロをもう少し伸ばしたりすればこの辺りでも色々もがもができそう．

また今回はそのままリストに書き換えましたが，ある列の平均求めたいとかならそれこそ
矩形選択とか置換とかその辺で思いのまま．あとやっぱりなんでも好きなフォーマットに
書き換えられるのはいいですね．

---

個人的にこれが楽，大事，嬉しいなって思うのは次のことがあるから．

* Vim 上でできるから，`.tex` 編集してるままで csv 整形→ コード追加→quickrun →結果を整形→ .tex に持込，と流れるようにできてやりやすい．ekuseru ってなんでしたっけ
* あれ `csv` どうやって使うんだっけと思い出したり調べたりしなくても，
たとえ使おうとしてる正規表現が汚くても（あるいは「このファイル」でないとつかえなくても），手に馴染んだ道具でとにかく手元のタスクは確実に捌けるということ．
それも，考えるのとほとんど並行してざく，ざくとやっていけば欲しい形に辿り着けるということ．

前者の利便性はもちろん大変なものだけど，今の僕にこの記事を書かせたのは後者のほうの感動で，
要はこれ一本あればどこでも大丈夫，みたいなお気に入りの筆記具とか，道具とか，
そういうものの価値，というような話だろうと思います．

でもジッサイ便利なのでこういう時は vim をつかおう．
